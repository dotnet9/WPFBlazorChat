@using Prism.Events
@using WPFBlazorChat.Events
@using WPFBlazorChat.Models
@using WPFBlazorChat.Services
@inject IUserService UserService
@inject IEventAggregator EventAggregator

<MApp Dark>
    <MAppBar Color="deep-purple accent-4 rounded-t-lg" App Dense @onmouseup="BarMouseUp" @onmousedown="BarMouseDown">
        <MAvatar Size="35" Class="ml-0 mr-5">
            <MImage Src="https://dotnet9.com/images/logo.png">
            </MImage>
        </MAvatar>
        <MToolbarTitle>点击人物打开一个微信（假装）</MToolbarTitle>
        <MSpacer></MSpacer>
        <MButton icon>
            <MIcon>mdi-magnify</MIcon>
        </MButton>

        <MMenu Left
               Bottom>
            <ActivatorContent>
                <MButton Icon @attributes="@context.Attrs">
                    <MIcon>mdi-dots-vertical</MIcon>
                </MButton>
            </ActivatorContent>
            <ChildContent>
                <MList>
                    <MListItem @key="1" Href="https://dotnet9.com">
                        <MListItemTitle>网站 Dotnet9.com</MListItemTitle>
                    </MListItem>
                    <MListItem @key="2" Href="https://img1.dotnet9.com/site/wechatpublic.jpg">
                        <MListItemTitle>公众号 Dotnet9</MListItemTitle>
                    </MListItem>
                    <MListItem @key="3" OnClick="Close">
                        <MListItemTitle>退出</MListItemTitle>
                    </MListItem>
                </MList>
            </ChildContent>
        </MMenu>
    </MAppBar>

    <MCard Class="mx-auto rounded-lg">
        <MList ThreeLine Class="rounded-lg">

            <MSubheader>人物列表</MSubheader>
            @if (_users is {Count:>0})
            {
                @foreach (var user in _users)
                {
                    <MListItem OnClick="() => ShowUser(user)">
                        <MListItemAvatar>
                            <MImage Src="@user.Avatar"></MImage>
                        </MListItemAvatar>

                        <MListItemContent>
                            <MListItemTitle>@((MarkupString)user.UserName)</MListItemTitle>
                            <MListItemSubtitle>@((MarkupString)user.Memo)</MListItemSubtitle>
                        </MListItemContent>
                    </MListItem>
                    <MDivider Inset="true"></MDivider>
                }
            }
        </MList>
    </MCard>
</MApp>

@code
{
    List<User>? _users = null;

    protected override Task OnInitializedAsync()
    {
        _users = UserService.GetUsers();
        return base.OnInitializedAsync();
    }

    void BarMouseDown(MouseEventArgs e)
    {
        Helpers.MouseMove.StartMove();
    }

    void BarMouseUp()
    {
        Helpers.MouseMove.EndMove();
    }

    void Close()
    {
        System.Windows.Application.Current.MainWindow?.Close();
    }

    void ShowUser(User user)
    {
        EventAggregator.GetEvent<OpenUserDialogEvent>().Publish(user);
    }
}